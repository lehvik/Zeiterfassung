<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Erfasse deine Arbeitszeiten einfach und zuverl√§ssig">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zeiterfassung">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>Arbeitszeit Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* Setup Screen */
        .setup-screen {
            display: none;
        }

        .setup-screen.active {
            display: block;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
            color: #1976D2;
        }

        .info-box ol {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* Main App Screen */
        .main-screen {
            display: none;
        }

        .main-screen.active {
            display: block;
        }

        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-date {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
        }

        .current-status {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .tracking-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .track-btn {
            padding: 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .track-btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .track-btn:active:before {
            width: 300px;
            height: 300px;
        }

        .track-btn.home-departure {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .track-btn.work-arrival {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .track-btn.work-departure {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .track-btn.home-arrival {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .track-btn.secondary {
            background: #e0e0e0;
            color: #666;
        }

        .track-btn.completed {
            background: #90a4ae;
            color: white;
        }

        .track-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .track-btn .time {
            display: block;
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* Work Mode Selector */
        .work-mode-section {
            margin-bottom: 20px;
        }

        .work-mode-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .work-mode-selector {
            position: relative;
        }

        select {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            appearance: none;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .work-mode-selector::after {
            content: '‚ñº';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #666;
            font-size: 12px;
        }

        .mode-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f4ff;
            border-radius: 20px;
            font-size: 13px;
            color: #667eea;
            font-weight: 500;
            margin-top: 10px;
        }

        .mode-indicator.urlaub {
            background: #fff3e0;
            color: #f57c00;
        }

        .mode-indicator.krank {
            background: #ffebee;
            color: #c62828;
        }

        .mode-indicator.homeoffice {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .mode-indicator.stempeln {
            background: #e3f2fd;
            color: #1976d2;
        }

        .settings-btn {
            background: #f5f5f5;
            color: #666;
            padding: 12px;
            font-size: 14px;
        }

        .settings-btn:hover {
            background: #e0e0e0;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #f44336;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-export {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(17, 153, 142, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div class="card setup-screen active" id="setupScreen">
            <h1>‚öôÔ∏è Einrichtung</h1>
            <p class="subtitle">Verbinde die App mit Google Sheets</p>

            <div class="info-box">
                <strong>üìã Vorbereitung (einmalig):</strong>
                <ol>
                    <li>√ñffne dein Google Sheet f√ºr die Zeiterfassung</li>
                    <li>Men√º: Erweiterungen ‚Üí Apps Script</li>
                    <li>L√∂sche den vorhandenen Code</li>
                    <li>Kopiere den Code aus der Datei "Code.gs" (wurde bereitgestellt)</li>
                    <li>F√ºge den Code ein und speichere (Disketten-Symbol)</li>
                    <li>Klicke "Bereitstellen" ‚Üí "Neue Bereitstellung"</li>
                    <li>Typ ausw√§hlen: "Web-App"</li>
                    <li>Ausf√ºhren als: "Ich"</li>
                    <li>Zugriff: "Jeder"</li>
                    <li>Klicke "Bereitstellen" und kopiere die Web-App-URL</li>
                </ol>
            </div>

            <form id="setupForm">
                <div class="form-group">
                    <label for="appsScriptUrl">Google Apps Script Web-App-URL *</label>
                    <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/..." required>
                    <div class="hint">Die URL erh√§ltst du nach dem Deployment des Apps Scripts</div>
                </div>

                <div class="form-group">
                    <label for="sheetName">Tabellenblatt-Name (optional)</label>
                    <input type="text" id="sheetName" placeholder="Zeiterfassung" value="Zeiterfassung">
                    <div class="hint">Name des Blattes in deinem Spreadsheet</div>
                </div>

                <button type="submit" class="btn-primary">
                    Verbindung testen & speichern
                </button>
            </form>
        </div>

        <!-- Main App Screen -->
        <div class="card main-screen" id="mainScreen">
            <h1>‚è±Ô∏è Arbeitszeit Tracker</h1>
            <p class="subtitle">Erfasse deine t√§glichen Zeiten</p>

            <div class="status-display">
                <div class="current-date" id="currentDate"></div>
                <div class="current-status" id="currentStatus">Bereit zum Tracken</div>
            </div>

            <div class="work-mode-section">
                <label class="work-mode-label" for="workMode">üìã Arbeitsmodus</label>
                <div class="work-mode-selector">
                    <select id="workMode">
                        <option value="normal">Normal (Pendeln ins B√ºro)</option>
                        <option value="homeoffice">üè† HomeOffice</option>
                        <option value="stempeln">üè¢ Stempeln (nur B√ºro)</option>
                        <option value="urlaub">üèñÔ∏è Urlaub</option>
                        <option value="krank">ü§í Krank</option>
                    </select>
                </div>
            </div>

            <div class="tracking-buttons">
                <button class="track-btn home-departure" data-type="home-departure">
                    üè† ‚Üí üöó Losfahrt von Zuhause
                    <span class="time" id="time-home-departure"></span>
                </button>

                <button class="track-btn work-arrival" data-type="work-arrival">
                    üöó ‚Üí üè¢ Ankunft auf der Arbeit
                    <span class="time" id="time-work-arrival"></span>
                </button>

                <button class="track-btn work-departure" data-type="work-departure">
                    üè¢ ‚Üí üöó Losfahrt von der Arbeit
                    <span class="time" id="time-work-departure"></span>
                </button>

                <button class="track-btn home-arrival" data-type="home-arrival">
                    üöó ‚Üí üè† Ankunft Zuhause
                    <span class="time" id="time-home-arrival"></span>
                </button>
            </div>

            <div class="export-section">
                <button class="btn-export" id="exportBtn">
                    üìä Daten als CSV exportieren
                </button>
            </div>

            <button class="btn-secondary settings-btn" id="settingsBtn">
                ‚öôÔ∏è Einstellungen √§ndern
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuration
        let config = {
            appsScriptUrl: '',
            sheetName: 'Zeiterfassung'
        };

        // Today's tracking data
        let todayData = {
            date: '',
            workMode: 'normal',
            'home-departure': '',
            'work-arrival': '',
            'work-departure': '',
            'home-arrival': ''
        };

        // Initialize app
        function init() {
            loadConfig();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            if (config.appsScriptUrl) {
                showMainScreen();
                loadTodayData();
            } else {
                showSetupScreen();
            }

            // Event listeners
            document.getElementById('setupForm').addEventListener('submit', handleSetup);
            document.getElementById('settingsBtn').addEventListener('click', showSetupScreen);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('workMode').addEventListener('change', handleWorkModeChange);
            
            document.querySelectorAll('.track-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleTrack(e.target.closest('.track-btn')));
            });
        }

        // Load configuration from localStorage
        function loadConfig() {
            const saved = localStorage.getItem('timetracker-config');
            if (saved) {
                config = JSON.parse(saved);
            }
        }

        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('timetracker-config', JSON.stringify(config));
        }

        // Handle work mode change
        function handleWorkModeChange(e) {
            todayData.workMode = e.target.value;
            updateButtonVisibility();
            saveToGoogleSheets();
            
            const modeNames = {
                'normal': 'Normal (Pendeln)',
                'homeoffice': 'HomeOffice',
                'stempeln': 'Stempeln (B√ºro)',
                'urlaub': 'Urlaub',
                'krank': 'Krank'
            };
            
            showToast(`üìã Modus ge√§ndert: ${modeNames[e.target.value]}`, 'success');
        }

        // Update button visibility based on work mode
        function updateButtonVisibility() {
            const mode = todayData.workMode;
            const buttons = {
                'home-departure': document.querySelector('[data-type="home-departure"]'),
                'work-arrival': document.querySelector('[data-type="work-arrival"]'),
                'work-departure': document.querySelector('[data-type="work-departure"]'),
                'home-arrival': document.querySelector('[data-type="home-arrival"]')
            };

            // Reset all buttons
            Object.values(buttons).forEach(btn => {
                btn.style.display = 'block';
            });

            // Adjust based on mode
            if (mode === 'homeoffice') {
                // HomeOffice: nur Arbeitsbeginn und -ende
                buttons['home-departure'].style.display = 'none';
                buttons['home-arrival'].style.display = 'none';
                buttons['work-arrival'].innerHTML = 'üíº Arbeitsbeginn (HomeOffice)<span class="time" id="time-work-arrival"></span>';
                buttons['work-departure'].innerHTML = 'üèÅ Arbeitsende (HomeOffice)<span class="time" id="time-work-departure"></span>';
            } else if (mode === 'stempeln') {
                // Stempeln: nur Ankunft und Losfahrt von Arbeit
                buttons['home-departure'].style.display = 'none';
                buttons['home-arrival'].style.display = 'none';
                buttons['work-arrival'].innerHTML = 'üè¢ Ankunft B√ºro (Stempeln)<span class="time" id="time-work-arrival"></span>';
                buttons['work-departure'].innerHTML = 'üè¢ Verlassen B√ºro (Stempeln)<span class="time" id="time-work-departure"></span>';
            } else if (mode === 'urlaub' || mode === 'krank') {
                // Urlaub/Krank: keine Buttons n√∂tig
                Object.values(buttons).forEach(btn => {
                    btn.style.display = 'none';
                });
            } else {
                // Normal mode: restore original labels
                buttons['home-departure'].innerHTML = 'üè† ‚Üí üöó Losfahrt von Zuhause<span class="time" id="time-home-departure"></span>';
                buttons['work-arrival'].innerHTML = 'üöó ‚Üí üè¢ Ankunft auf der Arbeit<span class="time" id="time-work-arrival"></span>';
                buttons['work-departure'].innerHTML = 'üè¢ ‚Üí üöó Losfahrt von der Arbeit<span class="time" id="time-work-departure"></span>';
                buttons['home-arrival'].innerHTML = 'üöó ‚Üí üè† Ankunft Zuhause<span class="time" id="time-home-arrival"></span>';
            }

            updateButtonStates();
        }

        // Update button states (primary/secondary/completed)
        function updateButtonStates() {
            const mode = todayData.workMode;
            
            // Don't update buttons for urlaub/krank
            if (mode === 'urlaub' || mode === 'krank') {
                return;
            }

            const buttons = document.querySelectorAll('.track-btn');
            let visibleButtons = Array.from(buttons).filter(btn => btn.style.display !== 'none');
            
            // Find next button to highlight
            let nextButtonIndex = -1;
            
            for (let i = 0; i < visibleButtons.length; i++) {
                const btn = visibleButtons[i];
                const type = btn.dataset.type;
                
                if (todayData[type]) {
                    // Button has time - mark as completed
                    btn.classList.remove('secondary');
                    btn.classList.add('completed');
                } else {
                    // Button doesn't have time yet
                    if (nextButtonIndex === -1) {
                        // This is the next button to be clicked - primary color
                        nextButtonIndex = i;
                        btn.classList.remove('secondary', 'completed');
                    } else {
                        // Future buttons - secondary color
                        btn.classList.remove('completed');
                        btn.classList.add('secondary');
                    }
                }
            }
        }

        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('de-DE', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        // Show setup screen
        function showSetupScreen() {
            document.getElementById('setupScreen').classList.add('active');
            document.getElementById('mainScreen').classList.remove('active');
            
            // Pre-fill form
            document.getElementById('appsScriptUrl').value = config.appsScriptUrl || '';
            document.getElementById('sheetName').value = config.sheetName || 'Zeiterfassung';
        }

        // Show main screen
        function showMainScreen() {
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.add('active');
        }

        // Handle setup form submission
        async function handleSetup(e) {
            e.preventDefault();
            
            const appsScriptUrl = document.getElementById('appsScriptUrl').value.trim();
            const sheetName = document.getElementById('sheetName').value.trim() || 'Zeiterfassung';

            // Test connection
            showToast('Verbindung wird getestet...', 'info');
            
            try {
                const testResult = await testAppsScriptConnection(appsScriptUrl);
                
                if (testResult.success) {
                    config.appsScriptUrl = appsScriptUrl;
                    config.sheetName = sheetName;
                    saveConfig();
                    
                    showToast('‚úÖ Verbindung erfolgreich!', 'success');
                    setTimeout(() => {
                        showMainScreen();
                        loadTodayData();
                    }, 1500);
                } else {
                    showToast('‚ùå Verbindung fehlgeschlagen: ' + testResult.error, 'error');
                }
            } catch (error) {
                showToast('‚ùå Fehler: ' + error.message, 'error');
            }
        }

        // Test Apps Script connection
        async function testAppsScriptConnection(url) {
            try {
                const testUrl = `${url}?action=test`;
                const response = await fetch(testUrl);
                
                if (!response.ok) {
                    return { 
                        success: false, 
                        error: 'HTTP-Fehler: ' + response.status 
                    };
                }
                
                const data = await response.json();
                
                if (data.success) {
                    return { success: true };
                } else {
                    return { 
                        success: false, 
                        error: data.error || 'Unbekannter Fehler' 
                    };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Load today's data from Google Sheets via Apps Script
        async function loadTodayData() {
            try {
                const today = new Date().toLocaleDateString('de-DE');
                todayData.date = today;
                
                const url = `${config.appsScriptUrl}?action=getToday&date=${encodeURIComponent(today)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Failed to load data');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    todayData.workMode = result.data.workMode || 'normal';
                    todayData['home-departure'] = result.data['home-departure'] || '';
                    todayData['work-arrival'] = result.data['work-arrival'] || '';
                    todayData['work-departure'] = result.data['work-departure'] || '';
                    todayData['home-arrival'] = result.data['home-arrival'] || '';
                    
                    // Update dropdown
                    document.getElementById('workMode').value = todayData.workMode;
                    
                    updateButtonVisibility();
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading today data:', error);
            }
        }

        // Handle tracking button click
        async function handleTrack(btn) {
            const type = btn.dataset.type;
            const now = new Date();
            const timeStr = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            
            todayData[type] = timeStr;
            updateUI();
            updateButtonStates();
            
            // Save to Google Sheets
            await saveToGoogleSheets();
            
            showToast(`‚úÖ ${btn.textContent.split('\n')[0]} um ${timeStr} erfasst`, 'success');
        }

        // Update UI with current data
        function updateUI() {
            Object.keys(todayData).forEach(key => {
                if (key !== 'date' && key !== 'workMode') {
                    const timeEl = document.getElementById(`time-${key}`);
                    if (timeEl) {
                        timeEl.textContent = todayData[key] ? `‚úì ${todayData[key]}` : '';
                    }
                }
            });
            
            // Update status
            const mode = todayData.workMode;
            const modeEmojis = {
                'normal': 'üöó',
                'homeoffice': 'üè†',
                'stempeln': 'üè¢',
                'urlaub': 'üèñÔ∏è',
                'krank': 'ü§í'
            };
            
            if (mode === 'urlaub') {
                document.getElementById('currentStatus').textContent = 'üèñÔ∏è Heute: Urlaub';
            } else if (mode === 'krank') {
                document.getElementById('currentStatus').textContent = 'ü§í Heute: Krank';
            } else {
                const lastTracked = Object.entries(todayData)
                    .filter(([key, val]) => key !== 'date' && key !== 'workMode' && val)
                    .pop();
                
                if (lastTracked) {
                    const statusMap = {
                        'home-departure': 'Unterwegs zur Arbeit',
                        'work-arrival': mode === 'homeoffice' ? 'Arbeit begonnen (HomeOffice)' : mode === 'stempeln' ? 'Im B√ºro' : 'Auf der Arbeit',
                        'work-departure': mode === 'homeoffice' ? 'Arbeit beendet (HomeOffice)' : mode === 'stempeln' ? 'B√ºro verlassen' : 'Auf dem Heimweg',
                        'home-arrival': 'Zuhause angekommen'
                    };
                    document.getElementById('currentStatus').textContent = 
                        `${modeEmojis[mode]} Status: ${statusMap[lastTracked[0]]} (${lastTracked[1]})`;
                } else {
                    const modeNames = {
                        'normal': 'Normal (Pendeln)',
                        'homeoffice': 'HomeOffice',
                        'stempeln': 'Stempeln (B√ºro)'
                    };
                    document.getElementById('currentStatus').textContent = `Bereit zum Tracken - ${modeNames[mode]}`;
                }
            }
            
            updateButtonStates();
        }

        // Save to Google Sheets via Apps Script (using GET to avoid CORS)
        async function saveToGoogleSheets() {
            try {
                const today = todayData.date;
                
                // Translate work mode to German
                const modeTranslation = {
                    'normal': 'Normal',
                    'homeoffice': 'HomeOffice',
                    'stempeln': 'Stempeln',
                    'urlaub': 'Urlaub',
                    'krank': 'Krank'
                };
                
                // Build URL with parameters (GET request to avoid CORS)
                const params = new URLSearchParams({
                    action: 'save',
                    date: today,
                    workMode: modeTranslation[todayData.workMode] || todayData.workMode,
                    homeDeparture: todayData['home-departure'] || '',
                    workArrival: todayData['work-arrival'] || '',
                    workDeparture: todayData['work-departure'] || '',
                    homeArrival: todayData['home-arrival'] || ''
                });
                
                const url = `${config.appsScriptUrl}?${params.toString()}`;
                
                const response = await fetch(url, {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    console.error('Save failed:', result.error);
                    showToast('‚ö†Ô∏è Fehler beim Speichern', 'error');
                }
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                showToast('‚ö†Ô∏è Fehler beim Speichern', 'error');
            }
        }

        // Export to CSV via Apps Script
        async function exportToCSV() {
            try {
                const url = `${config.appsScriptUrl}?action=getAllData`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    showToast('‚ö†Ô∏è Keine Daten zum Exportieren', 'error');
                    return;
                }
                
                // Add headers
                const headers = ['Datum', 'Modus', 'Losfahrt Zuhause', 'Ankunft Arbeit', 'Losfahrt Arbeit', 'Ankunft Zuhause', 'Arbeitszeit', 'Pendelzeit'];
                const allRows = [headers, ...result.data];
                
                // Convert to CSV
                const csv = allRows.map(row => row.join(';')).join('\n');
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `arbeitszeit_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                showToast('‚úÖ CSV-Export erfolgreich!', 'success');
            } catch (error) {
                showToast('‚ùå Export fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registriert:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker Fehler:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after setup is complete
            if (config.apiKey && config.spreadsheetId) {
                showInstallPrompt();
            }
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            // Only show once per session
            if (sessionStorage.getItem('installPromptShown')) return;
            
            setTimeout(() => {
                const install = confirm('üì± M√∂chtest du die App auf deinem Ger√§t installieren?\n\nDann kannst du sie wie eine normale App verwenden!');
                
                if (install && deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            showToast('‚úÖ App wird installiert...', 'success');
                        }
                        deferredPrompt = null;
                    });
                }
                
                sessionStorage.setItem('installPromptShown', 'true');
            }, 3000);
        }

        window.addEventListener('appinstalled', () => {
            showToast('üéâ App erfolgreich installiert!', 'success');
            deferredPrompt = null;
        });

        // Start app
        init();
    </script>
</body>
</html>
